<script>
function dashboard() {
  return {
    user: { id: '', global_name: '', username: '', email: '', avatar: '' },
    apiKey: 'ct_sk_8f9e2a1b3c4d5e6f7g8h9i0j1k2l3m4n',

    init() {
      let token = this.getTokenFromHash();

      // If no token in URL, try localStorage
      if (!token) {
        token = localStorage.getItem('discord_token');
      }

      // NO TOKEN? â†’ GO TO LOGIN
      if (!token) {
        return this.redirectToLogin();
      }

      // SAVE TOKEN (for reloads)
      localStorage.setItem('discord_token', token);

      // FETCH USER
      fetch('https://discord.com/api/users/@me', {
        headers: { 'Authorization': `Bearer ${token}` }
      })
      .then(r => r.ok ? r.json() : Promise.reject())
      .then(data => {
        this.user = {
          id: data.id,
          username: data.username,
          global_name: data.global_name || data.username,
          email: data.email || 'Hidden',
          avatar: data.avatar
            ? `https://cdn.discordapp.com/avatars/${data.id}/${data.avatar}.png?size=256`
            : `https://cdn.discordapp.com/embed/avatars/${(data.discriminator || 0) % 5}.png`
        };
        this.apiKey = 'ct_sk_' + Math.random().toString(36).substr(2, 32);
        this.cleanUrl();
        this.initChart();
      })
      .catch(() => {
        localStorage.removeItem('discord_token');
        this.redirectToLogin();
      });
    },

    getTokenFromHash() {
      const hash = window.location.hash.substring(1);
      if (!hash) return null;
      const params = new URLSearchParams(hash);
      return params.get('access_token');
    },

    cleanUrl() {
      history.replaceState({}, '', '/CapTcha/dashboard.html');
    },

    redirectToLogin() {
      window.location.replace('login.html');
    },

    initChart() {
      const ctx = document.getElementById('solveChart');
      if (!ctx) return;
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
          datasets: [{
            data: [120, 190, 300, 250, 400, 380, 842],
            borderColor: '#a78bfa',
            backgroundColor: 'rgba(167, 139, 250, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: { responsive: true, plugins: { legend: { display: false } } }
      });
    },

    copyKey() {
      navigator.clipboard.writeText(this.apiKey).then(() => {
        const toast = document.createElement('div');
        toast.textContent = 'Copied!';
        toast.className = 'fixed bottom-4 right-4 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg z-50';
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 2000);
      });
    },

    regenerateKey() {
      if (confirm('Regenerate API key?')) {
        this.apiKey = 'ct_sk_' + Math.random().toString(36).substr(2, 32);
      }
    },

    logout() {
      if (confirm('Logout?')) {
        localStorage.removeItem('discord_token');
        window.location.replace('login.html');
      }
    }
  }
}
</script>
