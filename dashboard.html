<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard – CapTcha Tool</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .glass { 
      backdrop-filter: blur(12px); 
      background: rgba(255,255,255,0.08); 
      border: 1px solid rgba(255,255,255,0.1); 
    }
    .avatar { 
      transition: transform 0.3s ease; 
    }
    .avatar:hover { 
      transform: scale(1.1); 
    }
  </style>
</head>
<body class="bg-gradient-to-br from-gray-900 via-indigo-950 to-purple-950 text-gray-100 min-h-screen" x-data="dashboard()" x-init="init()">

<!-- Navbar -->
<header class="fixed top-0 w-full z-50 glass border-b border-white/10">
  <nav class="container mx-auto px-4 py-4 flex justify-between items-center">
    <a href="index.html" class="flex items-center space-x-2">
      <div class="w-10 h-10 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-lg flex items-center justify-center text-white font-bold">CT</div>
      <span class="text-xl font-bold">CapTcha Tool</span>
    </a>
    <div class="flex items-center space-x-4" x-show="user.id" x-cloak>
      <div class="flex items-center space-x-3">
        <img :src="user.avatar" alt="Avatar" class="w-9 h-9 rounded-full avatar object-cover ring-2 ring-indigo-500">
        <span class="text-sm font-medium" x-text="user.global_name || user.username"></span>
      </div>
      <button @click="copyKey()" class="text-sm px-3 py-1 bg-indigo-600 rounded-lg hover:bg-indigo-700 transition">
        <i class="fas fa-copy mr-1"></i>Copy Key
      </button>
      <button @click="logout()" class="text-sm text-red-400 hover:text-red-300 transition">
        <i class="fas fa-sign-out-alt mr-1"></i>Logout
      </button>
    </div>
  </nav>
</header>

<div class="pt-24 pb-12 container mx-auto px-4 max-w-6xl">

  <!-- Profile -->
  <div class="bg-white/5 glass rounded-2xl p-6 mb-8 text-center" x-show="user.id" x-cloak>
    <img :src="user.avatar" alt="Avatar" class="w-24 h-24 rounded-full mx-auto ring-4 ring-indigo-500 shadow-xl avatar mb-4">
    <h1 class="text-3xl font-bold" x-text="user.global_name || user.username"></h1>
    <p class="text-gray-400" x-text="user.email || 'Email Hidden'"></p>
    <p class="text-xs text-gray-500 mt-1">User ID: <span x-text="user.id"></span></p>
  </div>

  <!-- Loading -->
  <div class="text-center py-20" x-show="!user.id && !error">
    <div class="inline-block animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-indigo-500"></div>
    <p class="mt-4 text-gray-400">Signing you in...</p>
  </div>

  <!-- Error -->
  <div class="text-center py-20" x-show="error" x-cloak>
    <div class="inline-block mb-4 text-red-400 text-5xl">
      <i class="fas fa-exclamation-triangle"></i>
    </div>
    <p class="text-red-400 text-lg mb-2">Login failed or session expired.</p>
    <a href="login.html" class="inline-block px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
      <i class="fas fa-arrow-left mr-2"></i>Back to Login
    </a>
  </div>

  <!-- Stats -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8" x-show="user.id" x-cloak>
    <div class="bg-white/5 glass p-6 rounded-xl hover:bg-white/10 transition">
      <div class="flex items-center justify-between mb-2">
        <p class="text-sm text-gray-400">Solves Today</p>
        <i class="fas fa-check-circle text-indigo-400"></i>
      </div>
      <p class="text-3xl font-bold">842</p>
      <p class="text-xs text-gray-500 mt-1">+12% from yesterday</p>
    </div>
    <div class="bg-white/5 glass p-6 rounded-xl hover:bg-white/10 transition">
      <div class="flex items-center justify-between mb-2">
        <p class="text-sm text-gray-400">Success Rate</p>
        <i class="fas fa-bullseye text-green-400"></i>
      </div>
      <p class="text-3xl font-bold text-green-400">99.4%</p>
      <p class="text-xs text-gray-500 mt-1">Above average</p>
    </div>
    <div class="bg-white/5 glass p-6 rounded-xl hover:bg-white/10 transition">
      <div class="flex items-center justify-between mb-2">
        <p class="text-sm text-gray-400">Avg Solve Time</p>
        <i class="fas fa-bolt text-indigo-400"></i>
      </div>
      <p class="text-3xl font-bold text-indigo-400">1.1s</p>
      <p class="text-xs text-gray-500 mt-1">Lightning fast</p>
    </div>
    <div class="bg-white/5 glass p-6 rounded-xl hover:bg-white/10 transition">
      <div class="flex items-center justify-between mb-2">
        <p class="text-sm text-gray-400">Current Plan</p>
        <i class="fas fa-crown text-purple-400"></i>
      </div>
      <p class="text-3xl font-bold text-purple-400">Free</p>
      <a href="index.html#pricing" class="text-xs text-indigo-400 hover:text-indigo-300 mt-1 inline-block">Upgrade</a>
    </div>
  </div>

  <!-- Chart -->
  <div class="bg-white/5 glass p-6 rounded-xl mb-8" x-show="user.id" x-cloak>
    <h2 class="text-xl font-semibold mb-4 text-indigo-300">
      <i class="fas fa-chart-line mr-2"></i>Solve Activity (Last 7 Days)
    </h2>
    <canvas id="solveChart" height="100"></canvas>
  </div>

  <!-- API Key -->
  <div class="bg-white/5 glass p-6 rounded-xl" x-show="user.id" x-cloak>
    <h2 class="text-xl font-semibold mb-4 text-indigo-300">
      <i class="fas fa-key mr-2"></i>Your API Key
    </h2>
    <div class="flex flex-col sm:flex-row items-stretch sm:items-center space-y-3 sm:space-y-0 sm:space-x-3">
      <code class="flex-1 bg-gray-800/50 px-4 py-3 rounded-lg font-mono text-sm break-all" x-text="apiKey"></code>
      <button @click="copyKey()" class="px-4 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
        <i class="fas fa-copy mr-2"></i>Copy
      </button>
      <button @click="regenerateKey()" class="px-4 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
        <i class="fas fa-sync-alt mr-2"></i>Regenerate
      </button>
    </div>
    <p class="text-sm text-gray-400 mt-3">
      <i class="fas fa-info-circle mr-1"></i>Use this key in your scripts. Keep it secret and never share it publicly!
    </p>
  </div>
</div>

<script>
function dashboard() {
  return {
    user: { id: '', global_name: '', username: '', email: '', avatar: '' },
    apiKey: '',
    error: false,

    init() {
      // Try to get token from URL hash first
      let token = this.getTokenFromHash();

      // If no hash, try localStorage
      if (!token) {
        token = localStorage.getItem('discord_token');
      }

      // NO TOKEN? → Go to login
      if (!token) {
        return this.redirectToLogin();
      }

      // SAVE TOKEN
      localStorage.setItem('discord_token', token);

      // Clean URL (remove hash)
      this.cleanUrl();

      // Fetch user data
      this.fetchUser(token);
    },

    getTokenFromHash() {
      const hash = window.location.hash.substring(1);
      if (!hash) return null;
      const params = new URLSearchParams(hash);
      const token = params.get('access_token');
      return token;
    },

    cleanUrl() {
      if (window.location.hash) {
        const cleanUrl = window.location.pathname + window.location.search;
        history.replaceState({}, document.title, cleanUrl);
      }
    },

    fetchUser(token) {
      fetch('https://discord.com/api/v10/users/@me', {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      })
      .then(async r => {
        if (!r.ok) {
          const text = await r.text();
          console.error('Discord API Error:', r.status, text);
          throw new Error(`HTTP ${r.status}`);
        }
        return r.json();
      })
      .then(data => {
        this.user = {
          id: data.id,
          username: data.username,
          global_name: data.global_name || data.username,
          email: data.email || 'Hidden',
          avatar: data.avatar
            ? `https://cdn.discordapp.com/avatars/${data.id}/${data.avatar}.png?size=256`
            : `https://cdn.discordapp.com/embed/avatars/${(parseInt(data.discriminator) || 0) % 5}.png`
        };
        
        // Generate or retrieve API key
        const storedKey = localStorage.getItem('api_key_' + data.id);
        if (storedKey) {
          this.apiKey = storedKey;
        } else {
          this.apiKey = 'ct_sk_' + Math.random().toString(36).substr(2, 32);
          localStorage.setItem('api_key_' + data.id, this.apiKey);
        }
        
        // Initialize chart after user data is loaded
        this.$nextTick(() => this.initChart());
      })
      .catch(err => {
        console.warn('Login failed, clearing token:', err.message);
        localStorage.removeItem('discord_token');
        this.error = true;
        setTimeout(() => this.redirectToLogin(), 3000);
      });
    },

    redirectToLogin() {
      window.location.replace('login.html');
    },

    initChart() {
      const ctx = document.getElementById('solveChart');
      if (!ctx) return;
      
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
          datasets: [{
            label: 'Solves',
            data: [120, 190, 300, 250, 400, 380, 842],
            borderColor: '#a78bfa',
            backgroundColor: 'rgba(167, 139, 250, 0.1)',
            tension: 0.4,
            fill: true,
            pointRadius: 4,
            pointHoverRadius: 6,
            pointBackgroundColor: '#a78bfa',
            pointBorderColor: '#fff',
            pointBorderWidth: 2
          }]
        },
        options: { 
          responsive: true, 
          maintainAspectRatio: true,
          plugins: { 
            legend: { display: false },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              padding: 12,
              titleColor: '#fff',
              bodyColor: '#a78bfa',
              borderColor: '#a78bfa',
              borderWidth: 1
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                color: 'rgba(255, 255, 255, 0.1)'
              },
              ticks: {
                color: 'rgba(255, 255, 255, 0.6)'
              }
            },
            x: {
              grid: {
                display: false
              },
              ticks: {
                color: 'rgba(255, 255, 255, 0.6)'
              }
            }
          }
        }
      });
    },

    copyKey() {
      if (!this.apiKey) return;
      
      navigator.clipboard.writeText(this.apiKey).then(() => {
        this.showToast('API Key copied to clipboard!', 'success');
      }).catch(() => {
        this.showToast('Failed to copy. Please try manually.', 'error');
      });
    },

    regenerateKey() {
      if (confirm('Are you sure you want to regenerate your API key? This will invalidate your current key.')) {
        this.apiKey = 'ct_sk_' + Math.random().toString(36).substr(2, 32);
        localStorage.setItem('api_key_' + this.user.id, this.apiKey);
        this.showToast('New API key generated!', 'success');
      }
    },

    logout() {
      if (confirm('Are you sure you want to logout?')) {
        localStorage.removeItem('discord_token');
        window.location.replace('login.html');
      }
    },

    showToast(message, type = 'success') {
      const toast = document.createElement('div');
      const bgColor = type === 'success' ? 'bg-green-600' : 'bg-red-600';
      const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
      
      toast.innerHTML = `<i class="fas ${icon} mr-2"></i>${message}`;
      toast.className = `fixed bottom-4 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center animate-fade`;
      document.body.appendChild(toast);
      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateY(10px)';
        toast.style.transition = 'all 0.3s ease';
        setTimeout(() => toast.remove(), 300);
      }, 2500);
    }
  }
}
</script>
</body>
</html>
