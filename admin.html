<!DOCTYPE html>
<html lang="en" x-data="admin()" x-init="init()">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin – CapTcha Tool</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">

<!-- LOADING -->
<div x-show="loading" class="flex items-center justify-center min-h-screen">
  <div class="text-xl">Checking admin access...</div>
</div>

<!-- NOT ADMIN -->
<div x-show="!isAdmin && !loading" class="flex items-center justify-center min-h-screen">
  <div class="text-center">
    <h1 class="text-2xl font-bold mb-4">Admin Access Required</h1>
    <button @click="loginWithDiscord()" 
            class="px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
      Login with Discord
    </button>
  </div>
</div>

<!-- ADMIN DASHBOARD -->
<template x-if="isAdmin && !loading">
  <div>
    <!-- Navbar -->
    <header class="bg-gray-800 border-b border-gray-700 p-4">
      <div class="flex items-center justify-between">
        <h1 class="text-2xl font-bold">Admin Dashboard</h1>
        <div class="flex items-center space-x-4">
          <span class="text-sm">Welcome, <strong x-text="user.username"></strong></span>
          <button @click="logout()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Logout</button>
        </div>
      </div>
    </header>

    <!-- Tabs -->
    <div class="flex border-b border-gray-700">
      <button @click="activeTab='keys'" 
              :class="activeTab==='keys' ? 'border-b-2 border-indigo-500 text-indigo-400' : 'text-gray-400'"
              class="px-6 py-3">Keys</button>
      <button @click="activeTab='stats'" 
              :class="activeTab==='stats' ? 'border-b-2 border-indigo-500 text-indigo-400' : 'text-gray-400'"
              class="px-6 py-3">Stats</button>
    </div>

    <!-- KEYS TAB -->
    <div x-show="activeTab === 'keys'" class="p-6">
      <div class="bg-gray-800 rounded-lg overflow-hidden">
        <table class="w-full text-sm">
          <thead class="bg-gray-700">
            <tr>
              <th class="p-3 text-left">Key Code</th>
              <th class="p-3 text-left">Plan</th>
              <th class="p-3 text-left">Expires</th>
              <th class="p-3 text-left">Status</th>
              <th class="p-3 text-left">Claimed By</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="key in keys" :key="key.code">
              <tr class="border-b border-gray-800 hover:bg-gray-700/50">
                <td class="p-3 font-mono text-xs" x-text="key.code"></td>
                <td class="p-3" x-text="key.plan"></td>
                <td class="p-3" x-text="formatDate(key.expires)"></td>
                <td class="p-3">
                  <span :class="key.status === 'active' ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'"
                        class="px-2 py-1 rounded text-xs">
                    <span x-text="key.status"></span>
                  </span>
                </td>
                <td class="p-3 text-xs" x-text="key.claimedBy || '—'"></td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
    </div>

    <!-- STATS TAB -->
    <div x-show="activeTab === 'stats'" class="p-6 grid grid-cols-1 md:grid-cols-3 gap-6">
      <div class="bg-gray-800 p-6 rounded-lg">
        <h3 class="text-lg font-semibold text-gray-400">Total Keys</h3>
        <p class="text-3xl font-bold mt-2" x-text="keys.length"></p>
      </div>
      <div class="bg-gray-800 p-6 rounded-lg">
        <h3 class="text-lg font-semibold text-gray-400">Active Keys</h3>
        <p class="text-3xl font-bold mt-2 text-green-400" 
           x-text="keys.filter(k => k.status === 'active').length"></p>
      </div>
      <div class="bg-gray-800 p-6 rounded-lg">
        <h3 class="text-lg font-semibold text-gray-400">Total Injections</h3>
        <p class="text-3xl font-bold mt-2 text-blue-400" x-text="injections.length"></p>
      </div>
    </div>
  </div>
</template>

<script>
// === CONFIG ===
const DISCORD_CLIENT_ID = '963238863256567848';
const REDIRECT_URI = 'https://capovh.github.io/CapTcha/admin.html';
const GITHUB_RAW_URL = 'https://raw.githubusercontent.com/72395839745598327589k/dsadasdasd324e3242/refs/heads/main/keys.txt';
const ADMIN_DISCORD_IDS = ['1393017932610666577', '805954114231205978']; // Add your ID

// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyA9sJoZSzbmKJ-7F9jsYVmf7m4cMJ_JUuA",
  authDomain: "captcha-finder.firebaseapp.com",
  projectId: "captcha-finder",
  storageBucket: "captcha-finder.firebasestorage.app",
  messagingSenderId: "268327722037",
  appId: "1:268327722037:web:54ba44e1d4ccc2c734e57c"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

function admin() {
  return {
    loading: true,
    isAdmin: false,
    user: null,
    keys: [],
    injections: [],
    activeTab: 'keys',

    async init() {
      const urlParams = new URLSearchParams(window.location.search);
      const code = urlParams.get('code');

      if (code) {
        await this.exchangeCode(code);
        window.history.replaceState({}, document.title, window.location.pathname);
      } else {
        const saved = localStorage.getItem('discord_user');
        if (saved) {
          this.user = JSON.parse(saved);
          if (ADMIN_DISCORD_IDS.includes(this.user.id)) {
            this.isAdmin = true;
            await this.loadData();
          }
        }
      }
      this.loading = false;
    },

    async exchangeCode(code) {
      const tokenResponse = await fetch(`https://discord.com/api/oauth2/token`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({
          client_id: DISCORD_CLIENT_ID,
          client_secret: 'e-AcJZ15inxDOh7tovbhxEqYywfHb4bq', // ← GET FROM DISCORD DEV PORTAL
          grant_type: 'authorization_code',
          code: code,
          redirect_uri: REDIRECT_URI,
          scope: 'identify guilds'
        })
      });

      const tokenData = await tokenResponse.json();
      if (!tokenData.access_token) return;

      const userResponse = await fetch('https://discord.com/api/users/@me', {
        headers: { Authorization: `Bearer ${tokenData.access_token}` }
      });
      const user = await userResponse.json();

      localStorage.setItem('discord_user', JSON.stringify(user));

      if (ADMIN_DISCORD_IDS.includes(user.id)) {
        this.user = user;
        this.isAdmin = true;
        await this.loadData();
      } else {
        alert('You are not an admin.');
        this.logout();
      }
    },

    async loadData() {
      // Load keys from GitHub
      const res = await fetch(GITHUB_RAW_URL);
      const text = await res.text();
      const lines = text.trim().split('\n').filter(l => l);
      const githubKeys = lines.map(line => {
        const [code, plan, expires] = line.split('|');
        return { code, plan, expires, status: 'active', claimedBy: null };
      });

      // Load claimed keys from Firebase
      const snap = await db.ref('keys').once('value');
      const claimed = snap.val() || {};
      this.keys = githubKeys.map(k => ({
        ...k,
        claimedBy: claimed[k.code]?.claimedBy || null
      }));

      // Load injections
      const injSnap = await db.ref('injections').once('value');
      this.injections = Object.values(injSnap.val() || {});
    },

    loginWithDiscord() {
      const authUrl = `https://discord.com/oauth2/authorize?client_id=${DISCORD_CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&response_type=code&scope=identify%20guilds`;
      window.location = authUrl;
    },

    logout() {
      localStorage.removeItem('discord_user');
      this.isAdmin = false;
      this.user = null;
    },

    formatDate(date) {
      return new Date(date).toLocaleDateString();
    }
  };
}
</script>
</body>
</html>
