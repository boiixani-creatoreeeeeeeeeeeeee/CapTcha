<!DOCTYPE html>
<html lang="en" x-data="admin()" x-init="init()">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin – CapTcha Tool</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  <style>
    .skeleton { @apply bg-gray-700 animate-pulse rounded; }
  </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">

<!-- ERROR STATE -->
<div x-show="error" class="flex items-center justify-center min-h-screen p-6">
  <div class="text-center max-w-md">
    <p class="text-red-400 mb-4" x-text="error"></p>
    <button @click="init()" class="px-6 py-2 bg-indigo-600 rounded-lg">Retry</button>
  </div>
</div>

<!-- LOADING -->
<div x-show="loading && !error" class="flex items-center justify-center min-h-screen">
  <div class="text-xl">Loading dashboard...</div>
</div>

<!-- NOT ADMIN -->
<div x-show="!isAdmin && !loading && !error" class="flex items-center justify-center min-h-screen p-6">
  <div class="text-center">
    <h1 class="text-2xl font-bold mb-4">Admin Access Required</h1>
    <button @click="loginWithDiscord()"
            class="px-8 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-xl font-semibold hover:shadow-xl transition">
      Login with Discord
    </button>
  </div>
</div>

<!-- ADMIN DASHBOARD -->
<template x-if="isAdmin && !loading && !error">
  <div>
    <!-- Navbar -->
    <header class="bg-gray-800 border-b border-gray-700 p-4 sticky top-0 z-10">
      <div class="flex items-center justify-between">
        <h1 class="text-2xl font-bold">Admin Dashboard</h1>
        <div class="flex items-center space-x-4">
          <span class="text-sm">Welcome, <strong x-text="user.username"></strong></span>
          <button @click="logout()" class="px-4 py-2 bg-red-600 rounded-lg hover:bg-red-700">Logout</button>
        </div>
      </div>
    </header>

    <!-- Tabs -->
    <div class="flex border-b border-gray-700 sticky top-16 bg-gray-800 z-10">
      <button @click="activeTab='keys'; loadData()" 
              :class="activeTab==='keys' ? 'border-b-2 border-indigo-500 text-indigo-400' : 'text-gray-400'"
              class="px-6 py-3 font-medium">Keys</button>
      <button @click="activeTab='stats'" 
              :class="activeTab==='stats' ? 'border-b-2 border-indigo-500 text-indigo-400' : 'text-gray-400'"
              class="px-6 py-3 font-medium">Stats</button>
    </div>

    <!-- KEYS TAB -->
    <div x-show="activeTab === 'keys'" class="p-6 space-y-6">
      <!-- Summary -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="bg-gradient-to-r from-indigo-600 to-purple-600 p-5 rounded-xl text-white">
          <p class="text-sm opacity-90">Total Keys</p>
          <p class="text-3xl font-bold" x-text="keys.length"></p>
        </div>
        <div class="bg-gradient-to-r from-green-600 to-teal-600 p-5 rounded-xl text-white">
          <p class="text-sm opacity-90">Active</p>
          <p class="text-3xl font-bold" x-text="keys.filter(k => k.status === 'active').length"></p>
        </div>
        <div class="bg-gradient-to-r from-red-600 to-pink-600 p-5 rounded-xl text-white">
          <p class="text-sm opacity-90">Expired</p>
          <p class="text-3xl font-bold" x-text="keys.filter(k => k.status === 'expired').length"></p>
        </div>
      </div>

      <!-- Table -->
      <div class="bg-gray-800 rounded-xl overflow-hidden">
        <div class="p-4 border-b border-gray-700">
          <input x-model="search" type="text" placeholder="Search key or user..." 
                 class="w-full sm:w-64 px-4 py-2 bg-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm">
        </div>
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead class="bg-gray-700">
              <tr>
                <th class="p-3 text-left">Key Code</th>
                <th class="p-3 text-left">Plan</th>
                <th class="p-3 text-left">Expires</th>
                <th class="p-3 text-left">Status</th>
                <th class="p-3 text-left">Claimed By</th>
              </tr>
            </thead>
            <tbody>
              <template x-for="key in filteredKeys" :key="key.code">
                <tr class="border-b border-gray-700 hover:bg-gray-700/50">
                  <td class="p-3 font-mono text-xs text-indigo-300" x-text="key.code"></td>
                  <td class="p-3" x-text="key.plan"></td>
                  <td class="p-3" x-text="formatDate(key.expires)"></td>
                  <td class="p-3">
                    <span :class="key.status === 'active' ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'"
                          class="px-2 py-1 rounded text-xs font-medium">
                      <span x-text="key.status.toUpperCase()"></span>
                    </span>
                  </td>
                  <td class="p-3 text-xs" x-text="key.claimedBy || '—'"></td>
                </tr>
              </template>
              <tr x-show="filteredKeys.length === 0">
                <td colspan="5" class="text-center py-8 text-gray-500">No keys found.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- STATS TAB -->
    <div x-show="activeTab === 'stats'" class="p-6 grid grid-cols-1 md:grid-cols-3 gap-6">
      <div class="bg-gray-800 p-6 rounded-xl">
        <h3 class="text-lg font-semibold text-gray-400">Total Keys</h3>
        <p class="text-4xl font-bold mt-2" x-text="keys.length"></p>
      </div>
      <div class="bg-gray-800 p-6 rounded-xl">
        <h3 class="text-lg font-semibold text-gray-400">Active Keys</h3>
        <p class="text-4xl font-bold mt-2 text-green-400" x-text="keys.filter(k => k.status === 'active').length"></p>
      </div>
      <div class="bg-gray-800 p-6 rounded-xl">
        <h3 class="text-lg font-semibold text-gray-400">Total Injections</h3>
        <p class="text-4xl font-bold mt-2 text-blue-400" x-text="injections.length"></p>
      </div>
    </div>
  </div>
</template>

<script>
// === CONFIG ===
const DISCORD_CLIENT_ID = '963238863256567848';
const REDIRECT_URI = 'https://capovh.github.io/CapTcha/admin.html';
const GITHUB_RAW_URL = 'https://raw.githubusercontent.com/capovh/CapTcha/main/keyx.txt';
const ADMIN_DISCORD_IDS = ['1393017932610666577', '805954114231205978'];

// Firebase
const firebaseConfig = {
  apiKey: "AIzaSyA9sJoZSzbmKJ-7F9jsYVmf7m4cMJ_JUuA",
  authDomain: "captcha-finder.firebaseapp.com",
  projectId: "captcha-finder",
  storageBucket: "captcha-finder.firebasestorage.app",
  messagingSenderId: "268327722037",
  appId: "1:268327722037:web:54ba44e1d4ccc2c734e57c"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

function admin() {
  return {
    loading: false,
    error: null,
    isAdmin: false,
    user: null,
    keys: [],
    injections: [],
    activeTab: 'keys',
    search: '',
    refreshInterval: null,

    async init() {
      this.loading = true;
      this.error = null;

      try {
        const saved = localStorage.getItem('discord_user');
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');

        if (code) {
          await this.exchangeCode(code);
          window.history.replaceState({}, document.title, window.location.pathname);
        } else if (saved) {
          this.user = JSON.parse(saved);
          if (ADMIN_DISCORD_IDS.includes(this.user.id)) {
            this.isAdmin = true;
            await this.loadData();
            this.startAutoRefresh();
          }
        }
      } catch (err) {
        this.error = 'Login failed: ' + err.message;
      } finally {
        this.loading = false;
      }
    },

    async exchangeCode(code) {
      const res = await fetch('https://discord.com/api/oauth2/token', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({
          client_id: DISCORD_CLIENT_ID,
          client_secret: 'e-AcJZ15inxDOh7tovbhxEqYywfHb4bq',
          grant_type: 'authorization_code',
          code,
          redirect_uri: REDIRECT_URI
        })
      });
      const data = await res.json();
      if (!data.access_token) throw new Error('Invalid code');

      const userRes = await fetch('https://discord.com/api/users/@me', {
        headers: { Authorization: `Bearer ${data.access_token}` }
      });
      const user = await userRes.json();
      localStorage.setItem('discord_user', JSON.stringify(user));

      if (!ADMIN_DISCORD_IDS.includes(user.id)) {
        throw new Error('Not an admin');
      }

      this.user = user;
      this.isAdmin = true;
      await this.loadData();
      this.startAutoRefresh();
    },

    async loadData() {
      this.loading = true;
      this.error = null;
      try {
        const [keysRes, injSnap] = await Promise.all([
          fetch(GITHUB_RAW_URL),
          db.ref('injections').once('value')
        ]);

        if (!keysRes.ok) throw new Error('Failed to load keys.txt');

        const text = await keysRes.text();
        const lines = text.trim().split('\n').filter(l => l);
        const githubKeys = lines.map(line => {
          const [code, plan, expires] = line.split('|');
          const isExpired = new Date(expires) < new Date();
          return { code, plan, expires, status: isExpired ? 'expired' : 'active', claimedBy: null };
        });

        const claimedSnap = await db.ref('keys').once('value');
        const claimed = claimedSnap.val() || {};

        this.keys = githubKeys.map(k => ({
          ...k,
          claimedBy: claimed[k.code]?.claimedBy || null
        }));

        this.injections = Object.values(injSnap.val() || {});

      } catch (err) {
        this.error = 'Data load failed: ' + err.message;
        this.keys = [];
      } finally {
        this.loading = false;
      }
    },

    get filteredKeys() {
      if (!this.search) return this.keys;
      const s = this.search.toLowerCase();
      return this.keys.filter(k =>
        k.code.toLowerCase().includes(s) ||
        (k.claimedBy && k.claimedBy.toLowerCase().includes(s))
      );
    },

    startAutoRefresh() {
      if (this.refreshInterval) clearInterval(this.refreshInterval);
      this.refreshInterval = setInterval(() => this.loadData(), 30000);
    },

    loginWithDiscord() {
      const url = `https://discord.com/oauth2/authorize?client_id=${DISCORD_CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&response_type=code&scope=identify`;
      window.location = url;
    },

    logout() {
      localStorage.removeItem('discord_user');
      if (this.refreshInterval) clearInterval(this.refreshInterval);
      this.isAdmin = false;
      this.user = null;
      this.keys = [];
    },

    formatDate(date) {
      try {
        return new Date(date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
      } catch {
        return '—';
      }
    }
  };
}
</script>
</body>
</html>
